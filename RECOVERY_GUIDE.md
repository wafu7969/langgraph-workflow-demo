# 中断恢复功能使用指南

## 功能概述

本旅游规划系统现在支持**中断恢复**功能，允许用户在工作流中断后从中断点继续执行，避免重新开始整个规划过程。

## 核心特性

### ✅ 已实现功能

1. **自动状态保存**: 每个执行步骤都会自动保存到数据库
2. **会话管理**: 支持多个并发会话的独立状态跟踪
3. **智能恢复**: 从最后一个保存的状态点继续执行
4. **交互式选择**: 用户可以选择要恢复的具体会话
5. **状态完整性**: 保持消息历史、控制状态和执行进度

## 使用方法

### 1. 正常模式运行
```bash
# 启动新的旅游规划会话
python src/main.py
```

### 2. 恢复模式运行
```bash
# 交互式恢复 - 选择要恢复的会话
python src/main.py resume

# 或者使用演示脚本
python resume_demo.py interactive
```

### 3. 查看可恢复的会话
```bash
# 列出所有可恢复的会话
python resume_demo.py demo
```

### 4. 测试恢复功能
```bash
# 运行完整的功能测试
python test_recovery.py
```

## 工作流程

### 正常执行流程
1. 用户启动旅游规划
2. 系统自动保存每个步骤的状态
3. 如果中断发生，状态已保存在数据库中

### 恢复执行流程
1. 用户选择恢复模式
2. 系统显示所有可恢复的会话
3. 用户选择要恢复的会话
4. 系统从中断点继续执行

## 技术实现

### 数据库结构
- **travel_sessions**: 存储会话基本信息
- **travel_states**: 存储每个步骤的详细状态
- **travel_info**: 存储旅游信息缓存

### 关键组件
- `database.py`: 数据库操作和状态管理
- `persistence.py`: 持久化接口和恢复逻辑
- `main.py`: 主执行流程和恢复入口

### 状态保存内容
- 消息历史 (messages)
- 用户查询 (user_query)
- 旅游信息 (travel_info)
- 成本分析 (cost_analysis)
- 行程安排 (itinerary)
- 控制状态 (_control)
- 执行状态 (status)

## 示例场景

### 场景1: 预算超支中断
```
用户: "日本豪华旅游7天，预算1000元"
系统: 分析后发现预算不足，等待用户确认
[用户关闭程序]
恢复: 系统从"等待确认"状态继续，用户可以选择优化方案
```

### 场景2: 网络中断恢复
```
用户: "欧洲10天旅游，预算20000元"
系统: 正在查询航班信息时网络中断
[程序异常退出]
恢复: 系统从"查询航班"步骤继续执行
```

## 注意事项

### ⚠️ 重要提醒
1. **数据持久性**: 所有状态保存在本地SQLite数据库中
2. **会话隔离**: 每个会话有独立的ID，互不干扰
3. **消息恢复**: 聊天历史完整保留，包括AI响应
4. **状态一致性**: 恢复后的状态与中断前完全一致

### 🔧 故障排除
1. **无法找到会话**: 检查数据库文件是否存在
2. **状态恢复失败**: 可能是数据格式问题，查看错误日志
3. **重复执行**: 确保使用正确的thread_id避免冲突

## 文件说明

- `resume_demo.py`: 恢复功能演示脚本
- `test_recovery.py`: 功能测试脚本
- `RECOVERY_GUIDE.md`: 本使用指南

## 开发者信息

### 扩展功能
如需添加新的恢复功能，请修改以下文件：
- `database.py`: 添加新的状态保存逻辑
- `persistence.py`: 扩展恢复接口
- `main.py`: 更新主执行流程

### 调试模式
在代码中设置 `DEBUG = True` 可以看到详细的状态保存和恢复日志。

---

**版本**: 1.0  
**更新时间**: 2025-12-13  
**作者**: Trae AI Assistant